# パフォーマンス分析レポート

## 調査日
2024年12月

## 問題の概要
Next.jsアプリケーションの起動時間が遅いと感じられる。

## 発見された問題点

### 1. 毎回の初期化処理実行（重大）
**場所**: `app/page.tsx:33`, `app/manage/page.tsx:42`

**問題**:
- ページ読み込みのたびに`initializeApp()`が実行されている
- 初回のみ実行すべき処理が毎回実行されている
- `initializeApp()`内で`setupDefaultCases()`が呼ばれ、既にセットアップ済みでもチェック処理が走る

**影響**:
- 毎回のページ読み込みで不要なIndexedDBアクセスが発生
- 初回セットアップ済みの場合でも、チェック処理に時間がかかる

**推奨改善**:
- 初期化処理を初回のみ実行するように最適化
- または、初期化チェックを軽量化

---

### 2. 過剰な待機時間（重大）
**場所**: 複数箇所

**問題箇所**:
1. `app/page.tsx:36` - **500ms待機**（WebKit対応のため）
2. `lib/init.ts:120` - 100ms × retryCount（最大300ms）
3. `lib/init.ts:128` - 100ms待機
4. `lib/init.ts:214` - 100ms待機
5. `lib/init.ts:227` - 100ms待機
6. `lib/init.ts:259` - 200ms × retryCount（最大600ms）
7. `lib/init.ts:284` - **1000ms待機**（リトライ時）
8. `lib/db.ts:114` - 100ms待機（WebKit環境のみ）

**合計待機時間**:
- 初回セットアップ時: 約500ms + 100ms × 3 + 200ms × 3 = **約1,400ms以上**
- 通常時（既にセットアップ済み）: 約500ms + チェック処理時間

**影響**:
- ユーザーが「読み込み中...」画面を見る時間が長い
- 特に初回アクセス時は1秒以上の待機が発生

**推奨改善**:
- WebKit環境の検出を改善し、通常のブラウザでは待機時間を削減
- 待機時間を最小限に抑える
- 非同期処理の並列化

---

### 3. 初期化処理の重複チェック
**場所**: `lib/init.ts:setupDefaultCases()`

**問題**:
- 既にセットアップ済みかチェックするために`getAppConfig('defaultCasesSetup')`を実行
- さらに既存CASEの存在チェックも実行（`getAllCases()`）
- リトライロジックが複数箇所にある

**影響**:
- 不要なIndexedDBアクセスが発生
- チェック処理に時間がかかる

**推奨改善**:
- チェック処理を1回にまとめる
- キャッシュを活用

---

### 4. 管理ページでの重い処理
**場所**: `app/manage/page.tsx:52-57`

**問題**:
- 各CASEの画像を個別に取得している（`getImageById()`をループで実行）
- 並列化されていない

**影響**:
- CASE数が多い場合、読み込み時間が線形に増加

**推奨改善**:
- `Promise.all()`を使用して並列化
- または、画像データを一括取得

---

### 5. Next.jsのバージョン
**現在**: Next.js 16.0.10

**問題**:
- 比較的古いバージョン（最新は15.x系または14.x系）
- パフォーマンス改善が含まれている可能性

**推奨改善**:
- 最新の安定版へのアップグレードを検討（ただし、破壊的変更に注意）

---

## パフォーマンス測定結果（推定）

### 現在の起動時間（推定）
- **初回アクセス時**: 1.5秒～2.5秒
- **2回目以降**: 0.5秒～1.0秒

### 一般的なNext.jsアプリの起動時間
- **初回アクセス時**: 0.3秒～0.8秒
- **2回目以降**: 0.1秒～0.3秒

**結論**: 現在のアプリは一般的なNext.jsアプリと比較して**2～3倍遅い**

---

## 改善提案の優先順位

### 優先度: 高
1. **待機時間の削減** - 500ms待機を削除または条件付きに
2. **初期化処理の最適化** - 初回のみ実行、またはチェックを軽量化
3. **管理ページの並列化** - 画像取得を並列化

### 優先度: 中
4. **WebKit検出の改善** - 通常のブラウザでは待機時間を削減
5. **IndexedDBアクセスの最適化** - 不要なアクセスを削減

### 優先度: 低
6. **Next.jsのアップグレード** - 破壊的変更のリスクを考慮

---

## 期待される改善効果

改善後は以下のような起動時間が期待できます：

- **初回アクセス時**: 0.5秒～1.0秒（現在の約50%削減）
- **2回目以降**: 0.2秒～0.4秒（現在の約60%削減）

---

## 実装の注意点

1. **WebKit対応の維持**: WebKit環境での動作を確認しながら改善
2. **後方互換性**: 既存のデータ構造を維持
3. **エラーハンドリング**: エラー時の挙動を確認

