# テスト不足レポート

## 調査日
2025年1月

## 概要
本レポートでは、hikaku-editorプロジェクトの既存テストコードを確認し、テストされていない機能やテストケースを洗い出しました。

## 既存テストのカバレッジ

### ✅ テストされている機能

#### 1. 初期表示とデフォルトCASE
- ✅ トップページの表示
- ✅ デフォルトCASE（3件）の作成
- ✅ 管理ページへの遷移

#### 2. CASE管理（基本）
- ✅ デフォルトCASEの表示
- ✅ 新規CASE追加
- ✅ CASE編集（タイトル変更）
- ✅ CASE削除

#### 3. 画像ライブラリ（基本）
- ✅ 画像ライブラリの表示
- ✅ デフォルト画像（6枚）の確認
- ✅ 検索機能
- ✅ URLから画像追加（基本）
- ✅ Google Drive URL変換
- ✅ 無効なURLのバリデーション

#### 4. データ永続性
- ✅ ページリロード後のCASE保持
- ✅ CASE追加後の永続化
- ✅ 画像の永続化
- ✅ CASE画像設定後の永続化

#### 5. 閲覧ページの機能（基本）
- ✅ スライダーの表示
- ✅ 調整パネルの開閉

#### 6. 新機能
- ✅ 初期表示アニメーション（自動リベール）
- ✅ アニメーション中断（クリック）
- ✅ アニメーション設定の確認
- ✅ フルスクリーンモード
- ✅ 比較モード切替（スライダー/左右比較）
- ✅ 初期スライダー位置設定の表示

#### 7. 共有機能（基本）
- ✅ 共有リンク生成
- ✅ 共有リンクコピー
- ✅ 共有専用ページの表示
- ✅ 共有プレビューの表示
- ✅ 共有CASEとして保存

#### 8. レスポンシブデザイン
- ✅ 横スクロールの発生チェック
- ✅ 調整パネル開閉時のレイアウト
- ✅ 画像ピッカーモーダルの表示

---

## ❌ テストされていない機能

### 🔴 優先度: 高（主要機能）

#### 1. CASE複製機能
**機能**: `handleDuplicateCase` - CASEを複製して新しいCASEを作成

**不足しているテスト**:
- CASE複製ボタンのクリック
- 複製されたCASEが「(コピー)」というタイトルで追加される
- 複製されたCASEが正しい位置（最後）に追加される
- 複製されたCASEの画像が正しく設定される
- 複製されたCASEの設定（初期スライダー位置、アニメーション）が正しくコピーされる

**テストファイル**: `e2e/app.spec.ts` または `e2e/new-features.spec.ts`

#### 2. CASE並び替え機能
**機能**: `handleMoveUp`, `handleMoveDown` - CASEの順序を変更

**現状**: テストがスキップされている（`app.spec.ts:136-139`）

**不足しているテスト**:
- 上へ移動ボタンのクリック
- 下へ移動ボタンのクリック
- 最初のCASEは上へ移動できない
- 最後のCASEは下へ移動できない
- 並び替え後の順序が正しく反映される
- 並び替え後の閲覧ページでの順序が正しい

**テストファイル**: `e2e/app.spec.ts`

#### 3. 画像アップロード機能（ファイルアップロード）
**機能**: ローカルファイルから画像をアップロード

**不足しているテスト**:
- ファイル選択ダイアログの表示
- 画像ファイルのアップロード
- 複数画像の一括アップロード
- アップロード後の画像がライブラリに表示される
- アップロード後の画像サイズ・寸法の表示
- 無効なファイル形式のエラーハンドリング
- ファイルサイズ制限の確認

**テストファイル**: `e2e/app.spec.ts` または新規ファイル

#### 4. 画像削除機能
**機能**: 画像ライブラリから画像を削除

**不足しているテスト**:
- 画像削除ボタンのクリック
- 削除確認ダイアログの表示
- 使用中の画像を削除しようとした場合の警告
- 画像削除後のライブラリからの削除
- 削除された画像が使用されているCASEでの表示（エラーまたはプレースホルダー）

**テストファイル**: `e2e/app.spec.ts`

#### 5. 調整パネル内の詳細機能
**機能**: 画像のズーム・位置調整と保存

**不足しているテスト**:
- 拡大率スライダーの操作（50-200%）
- 水平位置スライダーの操作（±200px）
- 垂直位置スライダーの操作（±200px）
- 数値入力フィールドでの直接入力
- 「位置・縮尺をリセット」ボタン
- 「この設定を初期表示として保存」ボタン
- 保存後の初期表示設定の反映
- Before/Afterそれぞれの独立した調整

**テストファイル**: `e2e/app.spec.ts` または `e2e/new-features.spec.ts`

#### 6. 全データ削除機能
**機能**: `clearAllData` - すべてのCASEと画像を削除

**不足しているテスト**:
- 「全データ削除」ボタンの表示
- 削除確認ダイアログの表示
- 全データ削除後のCASE一覧が空になる
- 全データ削除後の画像ライブラリが空になる
- 全データ削除後のトップページの表示（「CASEがありません」メッセージ）

**テストファイル**: `e2e/app.spec.ts`

### 🟡 優先度: 中（エラーハンドリング・エッジケース）

#### 7. エラーハンドリング（Error Boundary）
**機能**: `app/error.tsx`, `app/manage/error.tsx`

**不足しているテスト**:
- エラー発生時のError Boundaryの表示
- 「再試行」ボタンの動作
- 「トップページへ」ボタンの動作（トップページ）
- 「管理ページに戻る」ボタンの動作（管理ページ）

**テストファイル**: 新規ファイル `e2e/error-handling.spec.ts`

#### 8. Loading UI
**機能**: `app/loading.tsx`, `app/manage/loading.tsx`

**不足しているテスト**:
- ローディング中の表示
- Suspense fallbackの表示
- ローディング完了後のコンテンツ表示

**テストファイル**: 新規ファイル `e2e/loading.spec.ts`

#### 9. API Routesのエラーケース
**機能**: `app/api/fetch-image/route.ts`, `app/api/og/route.tsx`

**不足しているテスト**:
- 無効なURLでのエラーレスポンス
- プライベートIPアドレスの拒否
- HTTPS以外のプロトコルの拒否
- 許可されていないホスト名の拒否
- タイムアウトエラー
- 画像サイズ制限（10MB）の確認
- 無効なContent-Typeの拒否
- OG画像生成のエラーケース

**テストファイル**: 新規ファイル `e2e/api-routes.spec.ts`

#### 10. 共有機能のエラーケース
**機能**: 共有リンクのエラーハンドリング

**不足しているテスト**:
- 無効な共有リンク（デコードエラー）
- 画像が設定されていないCASEの共有
- URL画像ではない画像の共有エラー
- 共有プレビューでの画像読み込みエラー
- 共有リンクのハッシュ形式（`#share=...`）の処理

**テストファイル**: `e2e/new-features.spec.ts`

### 🟢 優先度: 低（細かい機能・UI）

#### 11. 初期スライダー位置の変更と反映
**機能**: 初期スライダー位置の設定と閲覧ページでの反映

**不足しているテスト**:
- 初期スライダー位置を変更（0%, 50%, 100%など）
- 変更後の閲覧ページでの初期位置の確認
- ガイドテキストの表示（「Before中心」「バランス」「After中心」）

**テストファイル**: `e2e/new-features.spec.ts`

#### 12. 画像のリサイズ・最適化
**機能**: アップロード時の自動リサイズ（長辺2000px、画質90%）

**不足しているテスト**:
- 大きな画像のアップロード時のリサイズ
- リサイズ後の画像サイズの確認
- リサイズ後の画像品質の確認

**テストファイル**: 新規ファイル `e2e/image-processing.spec.ts`

#### 13. 画像の使用状況表示
**機能**: 画像ライブラリでの使用中CASEの表示

**不足しているテスト**:
- 使用中の画像に「使用中」ラベルの表示
- 使用中の画像に使用CASE名の表示
- 未使用の画像に「未使用」ラベルの表示

**テストファイル**: `e2e/app.spec.ts`

#### 14. CASE編集の詳細機能
**機能**: CASE編集ページの全機能

**不足しているテスト**:
- 説明文の編集
- Before画像の選択・変更
- After画像の選択・変更
- 画像選択モーダルの表示・操作
- キャンセルボタンの動作
- 保存時のバリデーション

**テストファイル**: `e2e/app.spec.ts`

#### 15. 画像ピッカーの詳細機能
**機能**: `ImagePicker`コンポーネント

**不足しているテスト**:
- 画像ピッカーの表示
- 画像の選択
- 検索機能
- 選択後の画像割り当て

**テストファイル**: `e2e/app.spec.ts`

#### 16. Toast通知
**機能**: 成功・エラーメッセージの表示

**不足しているテスト**:
- 成功時のToast表示
- エラー時のToast表示
- Toastの自動非表示

**テストファイル**: 新規ファイル `e2e/toast.spec.ts`

#### 17. スライダーの詳細操作
**機能**: スライダーのドラッグ操作

**不足しているテスト**:
- スライダーのドラッグ操作
- スライダーのクリック操作
- タッチデバイスでのスライダー操作
- スライダー位置のリアルタイム更新

**テストファイル**: `e2e/app.spec.ts`

#### 18. フルスクリーンモードの詳細
**機能**: フルスクリーンAPIの使用

**不足しているテスト**:
- フルスクリーンへの遷移
- フルスクリーンからの終了
- フルスクリーン中のスライダー操作
- フルスクリーン中の調整パネル操作

**テストファイル**: `e2e/new-features.spec.ts`

---

## 推奨テスト追加順序

### フェーズ1: 即座に追加すべき（主要機能）
1. **CASE複製機能** - 主要機能の一つ
2. **CASE並び替え機能** - 既にスキップされているが重要
3. **画像アップロード機能** - 主要機能の一つ
4. **画像削除機能** - データ管理の基本機能
5. **調整パネルの詳細機能** - ユーザーが頻繁に使用する機能

### フェーズ2: 短期間で追加（エラーハンドリング）
6. **エラーハンドリング** - ユーザー体験に重要
7. **API Routesのエラーケース** - セキュリティと堅牢性
8. **共有機能のエラーケース** - エッジケースのカバー

### フェーズ3: 中長期的に追加（細かい機能）
9. **Loading UI** - UXの改善
10. **初期スライダー位置の詳細テスト** - 機能の完全性
11. **画像のリサイズ・最適化** - パフォーマンス確認
12. **その他の細かい機能** - 完全性の向上

---

## テスト追加の推奨ファイル構成

### 既存ファイルへの追加
- `e2e/app.spec.ts`: CASE管理、画像管理、調整機能
- `e2e/new-features.spec.ts`: 新機能の詳細テスト

### 新規ファイルの作成
- `e2e/error-handling.spec.ts`: エラーハンドリング
- `e2e/api-routes.spec.ts`: API Routesのテスト
- `e2e/image-processing.spec.ts`: 画像処理のテスト
- `e2e/toast.spec.ts`: Toast通知のテスト

---

## まとめ

### 現在のテストカバレッジ
- **基本機能**: ✅ 良好（約80%）
- **主要機能**: ⚠️ 一部不足（約60%）
- **エラーハンドリング**: ❌ 不足（約20%）
- **エッジケース**: ❌ 不足（約30%）

### 推奨アクション
1. **即座に追加**: CASE複製、並び替え、画像アップロード・削除、調整パネル詳細
2. **短期間で追加**: エラーハンドリング、API Routesエラーケース
3. **中長期的に追加**: Loading UI、細かい機能のテスト

### テスト追加による効果
- **品質向上**: バグの早期発見
- **回帰防止**: 既存機能の保護
- **ドキュメント**: 機能の使用方法の明確化
- **リファクタリング**: 安全なコード変更

---

## 参考情報

- 既存テストファイル: `e2e/app.spec.ts`, `e2e/new-features.spec.ts`, `e2e/responsive.spec.ts`
- テスト実行: `npm test`
- テスト設定: `playwright.config.ts`

